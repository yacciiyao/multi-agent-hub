# -*- coding: utf-8 -*-
# @File: agent_registry.py
# @Author: yaccii
# @Time: 2025-11-20 14:35
# @Description: Agent æ³¨å†Œè¡¨
from __future__ import annotations

from typing import Dict, List, Optional

from domain.agent import AgentConfig, TaskShortcut

_AGENTS: Dict[str, AgentConfig] = {}
_DEFAULT_KEY = "default_chat"


def _init_builtin_agents() -> None:
    """åˆå§‹åŒ–å†…ç½® Agentï¼ˆå…¬å…±ä»“åº“åªæ”¾é€šç”¨çš„ï¼Œä¸å«ä¸šåŠ¡å®šåˆ¶ï¼‰"""
    global _AGENTS

    if _AGENTS:
        return

    default_agent = AgentConfig(
        key=_DEFAULT_KEY,
        name="é»˜è®¤åŠ©æ‰‹",
        description="é€šç”¨å¯¹è¯åŠ©æ‰‹ï¼Œå¯ç»“åˆ RAG è¿›è¡ŒçŸ¥è¯†é—®ç­”ã€‚",
        icon="ğŸ¤–",
        bot_name="gpt-4o-mini",
        allowed_models=[],
        enable_rag=True,
        rag_top_k=5,
        supports_modalities=["text"],
        system_prompt=(
            "ä½ æ˜¯ä¸€ä¸ªé€šç”¨ä¸­æ–‡ AI åŠ©æ‰‹ï¼Œéœ€è¦å°½é‡å‡†ç¡®ã€æ¸…æ™°ã€æœ‰æ¡ç†åœ°å›ç­”ç”¨æˆ·é—®é¢˜ã€‚\n"
            "å½“ä¿¡æ¯ä¸è¶³æ—¶ï¼Œè¦ä¸»åŠ¨è¯´æ˜å‡è®¾ï¼Œä¸è¦ç¼–é€ å…·ä½“æ•°æ®æˆ–å¼•ç”¨ã€‚\n"
            "å¦‚æœé—®é¢˜ä¸ç³»ç»Ÿã€é¡¹ç›®é…ç½®ç›¸å…³ï¼Œå°½é‡ç»™å‡ºå¯æ‰§è¡Œçš„æ’æŸ¥æ­¥éª¤ã€‚"
        ),
        task_shortcuts=[
            TaskShortcut(
                id="qa_general",
                title="çŸ¥è¯†é—®ç­”",
                subtitle="æ ¹æ®å·²æœ‰çŸ¥è¯†åº“å›ç­”é—®é¢˜",
                prompt_template="è¯·æ ¹æ®çŸ¥è¯†åº“ï¼Œå¸®æˆ‘è§£ç­”è¿™ä¸ªé—®é¢˜ï¼š",
            ),
            TaskShortcut(
                id="summarize",
                title="æ€»ç»“å†…å®¹",
                subtitle="ä¸ºé•¿æ–‡æœ¬åšæ‘˜è¦å’Œè¦ç‚¹æå–",
                prompt_template="è¯·å¸®æˆ‘æ€»ç»“ä¸‹é¢è¿™æ®µå†…å®¹çš„è¦ç‚¹ï¼š",
            ),
        ],
    )

    brand_agent = AgentConfig(
        key="brand_ranking",
        name="å“ç‰Œèµ„è®¯åŠ©æ‰‹",
        description="åŸºäºå“ç‰Œåº“å’Œç¬¬ä¸‰æ–¹æ•°æ®ï¼Œç”ŸæˆçœŸå®çš„å“ç‰Œæ¦œå•æ•°æ®ã€‚",
        icon="ğŸ“Š",
        bot_name="gpt-4.1-mini",
        allowed_models=[],
        enable_rag=True,
        rag_top_k=5,
        supports_modalities=["text"],
        system_prompt=(
            "ä½ æ˜¯ä¸€åè·¨å¢ƒç”µå•†å“ç‰Œæ•°æ®åˆ†æå¸ˆï¼Œæ“…é•¿é˜…è¯»ç»“æ„åŒ–æ•°æ®ï¼ˆJSONã€è¡¨æ ¼ç­‰ï¼‰å’ŒèƒŒæ™¯èµ„æ–™ï¼Œ"
            "ä»ä¸­æç‚¼å‡ºå“ç‰Œæ ¼å±€ã€å¤´éƒ¨é›†ä¸­åº¦ã€æ–°é”å“ç‰Œè¡¨ç°ã€å“ç±»æœºä¼šç­‰ç»“è®ºã€‚\n"
            "å½“æˆ‘ç»™ä½ å“ç‰Œæ¦œå•æ•°æ®æ—¶ï¼Œè¯·éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š\n"
            "1. å…ˆç”¨ç®€çŸ­æ–‡å­—è¯´æ˜ç»Ÿè®¡å£å¾„ï¼ˆæ—¶é—´èŒƒå›´ã€æŒ‡æ ‡ã€åŒºåŸŸã€å“ç±»ç­‰ï¼‰ã€‚\n"
            "2. ç”¨è¡¨æ ¼æˆ–æ¡åˆ—å½¢å¼ç»™å‡º TOP å“ç‰ŒåŠå…¶æ ¸å¿ƒæŒ‡æ ‡ï¼ˆä¾‹å¦‚ scoreã€æœç´¢çƒ­åº¦ã€æµé‡ç­‰ï¼‰ã€‚\n"
            "3. é‡ç‚¹åˆ†æï¼šå¤´éƒ¨å“ç‰Œå’Œè…°éƒ¨å“ç‰Œçš„å·®å¼‚ï¼Œæ–°é”å“ç‰Œæ˜¯å¦åœ¨å¿«é€Ÿä¸Šå‡ï¼Œæœ‰æ— è€ç‰Œè¡°é€€ä¿¡å·ã€‚\n"
            "4. å¯ä»¥ç»“åˆæˆ‘æä¾›çš„èƒŒæ™¯èµ„æ–™ï¼ˆRAG æ–‡æœ¬ï¼‰ï¼Œä½†ä¸è¦ç¼–é€ å…·ä½“ GMV / é”€é‡ï¼Œåªå›´ç»•ç»™å®šæŒ‡æ ‡å’ŒèƒŒæ™¯åšæ¨æ–­ã€‚\n"
            "5. è¾“å‡ºé¢å‘è¡Œä¸šä»ä¸šè€…ï¼Œè¯­è¨€ä¸“ä¸šã€å®¢è§‚ã€ç»“æ„åŒ–ï¼Œé€‚åˆå†…éƒ¨å‘¨æŠ¥æˆ–è¡Œä¸šç®€æŠ¥å¼•ç”¨ã€‚\n"
        ),
        task_shortcuts=[
            TaskShortcut(
                id="brand_top_amazon_30d",
                title="æœ€è¿‘30å¤©äºšé©¬é€Šçƒ­åº¦æ¦œ",
                subtitle="æŒ‰æœç´¢çƒ­åº¦çœ‹å‡ºæµ·å“ç‰Œè¡¨ç°",
                prompt_template=(
                    "è¯·åŸºäºå†…éƒ¨å“ç‰Œæ•°æ®ï¼Œç”Ÿæˆæœ€è¿‘30å¤©å…¨çƒè·¨å¢ƒå“ç‰Œäºšé©¬é€Šæœç´¢çƒ­åº¦ TOP 30 æ¦œå•ï¼Œ"
                    "å¹¶è¾“å‡ºä¸€ä»½ç»“æ„åŒ–åˆ†ææŠ¥å‘Šã€‚"
                )
            ),
            TaskShortcut(
                id="brand_top_independence_traffic",
                title="ç‹¬ç«‹ç«™æµé‡æ¦œ",
                subtitle="æŒ‰ç‹¬ç«‹ç«™è®¿é—®é‡çœ‹å¤´éƒ¨å“ç‰Œ",
                prompt_template=(
                    "è¯·åŸºäºå†…éƒ¨æ•°æ®ï¼Œç”Ÿæˆæœ€è¿‘90å¤©ç‹¬ç«‹ç«™è®¿é—®æµé‡è¡¨ç°æœ€å¥½çš„å“ç‰Œæ¦œå•ï¼ˆè‡³å°‘ TOP 20ï¼‰ï¼Œ"
                    "å¹¶åˆ†æè¿™äº›å“ç‰Œåœ¨å›½å®¶åˆ†å¸ƒã€æµé‡ç»“æ„ï¼ˆç›´è®¿/æœç´¢/ç¤¾åª’ç­‰ï¼‰ä¸Šçš„å…±æ€§ä¸å·®å¼‚ã€‚"
                )
            ),
            TaskShortcut(
                id="single_brand_diagnose",
                title="å•å“ç‰Œè¯Šæ–­",
                subtitle="è¾“å…¥å“ç‰Œåï¼Œä¸€é”®ä½“æ£€",
                prompt_template=(
                    "è¯·å¯¹ä¸‹é¢è¿™ä¸ªå“ç‰Œåšä¸€æ¬¡è¯Šæ–­åˆ†æï¼ŒåŒ…æ‹¬ï¼šåŸºæœ¬ç›˜ï¼ˆå“ç±»ã€åœ°åŒºï¼‰ã€çƒ­åº¦èµ°åŠ¿ã€æ¸ é“è¡¨ç°ã€"
                    "æ½œåœ¨æœºä¼šä¸é£é™©ï¼Œå¹¶ç»™å‡º3~5æ¡å¯æ‰§è¡Œå»ºè®®ã€‚\n\nå“ç‰Œåç§°ï¼š"
                )
            ),
        ],
    )

    project_agent = AgentConfig(
        key="project_ranking",
        name="ä¼—ç­¹é¡¹ç›®åŠ©æ‰‹",
        description="åŸºäºå¤šä¸ªä¼—ç­¹å¹³å°æ•°æ®ç”Ÿæˆä¼—ç­¹æ¦œå•ã€é¡¹ç›®åˆ†æä¸è¡Œä¸šè§‚å¯Ÿã€‚",
        icon="ğŸš€",
        bot_name="gpt-4.1-mini",
        allowed_models=[],
        enable_rag=True,
        rag_top_k=5,
        supports_modalities=["text"],
        system_prompt=(
            "ä½ æ˜¯ä¸€åä¸“æ³¨äºä¼—ç­¹å¹³å°ï¼ˆKickstarter / Indiegogo / Makuake ç­‰ï¼‰çš„æ•°æ®åˆ†æå¸ˆï¼Œ"
            "ç†Ÿæ‚‰ä¼—ç­¹é¡¹ç›®çš„ç­¹æ¬¾èŠ‚å¥ã€å“ç±»ç‰¹å¾å’Œåœ°åŒºå·®å¼‚ã€‚\n"
            "å½“æˆ‘ç»™ä½ ä¼—ç­¹é¡¹ç›®çš„ç»“æ„åŒ–æ•°æ®ï¼ˆä¾‹å¦‚ JSON æ•°ç»„ï¼ŒåŒ…å«ç­¹æ¬¾é‡‘é¢ã€æ”¯æŒäººæ•°ã€å›½å®¶ã€å“ç±»ç­‰å­—æ®µï¼‰æ—¶ï¼š\n"
            "1. å…ˆè¯´æ˜ç»Ÿè®¡å£å¾„ï¼šæ—¶é—´èŒƒå›´ã€å¹³å°èŒƒå›´ã€æ’åºæŒ‡æ ‡ï¼ˆæ€»ç­¹æ¬¾é‡‘é¢ / ç­¹æ¬¾é€Ÿåº¦ç­‰ï¼‰ã€‚\n"
            "2. ç”¨è¡¨æ ¼æˆ–æ¡åˆ—å½¢å¼ç»™å‡ºæ¦œå• TOP é¡¹ç›®åŠå…¶å…³é”®æŒ‡æ ‡ï¼ˆç­¹æ¬¾é‡‘é¢ã€æ”¯æŒäººæ•°ã€å›½å®¶/åœ°åŒºã€å“ç±»ç­‰ï¼‰ã€‚\n"
            "3. åˆ†æå¤´éƒ¨é¡¹ç›®çš„å…±æ€§ï¼šé¢˜æã€ä»·æ ¼å¸¦ã€ç›®æ ‡å›½å®¶ã€äººç¾¤å®šä½ã€æ•…äº‹æ‰“æ³•ç­‰ï¼ˆåŸºäºå·²æœ‰å­—æ®µåˆç†æ¨æ–­ï¼‰ã€‚\n"
            "4. è¯†åˆ«æ½œåœ¨é£é™©ï¼šè¿‡é«˜ç›®æ ‡é‡‘é¢ã€è¿›åº¦å¼‚å¸¸ã€æ›´æ–°/è¯„è®ºæ¬¡æ•°å¼‚å¸¸ç­‰ï¼Œä½†ä¸è¦ç¼–é€ æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„æ•°æ®ã€‚\n"
            "5. å¦‚æœ‰æä¾›é¢å¤–çš„æ–‡æœ¬èƒŒæ™¯ï¼ˆRAG æ£€ç´¢ç»“æœï¼‰ï¼Œå¯ä»¥é€‚åº¦å¼•ç”¨ï¼Œç”¨æ¥æ”¯æŒä½ çš„è§‚ç‚¹ï¼Œä½†è¦æ ‡æ˜æ˜¯æ¨æµ‹ã€‚\n"
            "6. è¾“å‡ºç»“æ„æ¸…æ™°ã€é€‚åˆè¡Œä¸šä»ä¸šè€…é˜…è¯»ï¼Œå¯ä»¥ä½œä¸ºå†…éƒ¨å‘¨æŠ¥æˆ–ä¸“é¢˜æŠ¥å‘Šçš„ä¸€éƒ¨åˆ†ã€‚\n"
        ),
        task_shortcuts=[
            TaskShortcut(
                id="project_top_90d",
                title="æœ€è¿‘90å¤©ä¼—ç­¹æ¦œ",
                subtitle="æŒ‰æ€»ç­¹æ¬¾é¢çœ‹å¤´éƒ¨é¡¹ç›®",
                prompt_template=(
                    "è¯·åŸºäºå†…éƒ¨ä¼—ç­¹é¡¹ç›®æ•°æ®ï¼Œç”Ÿæˆæœ€è¿‘90å¤©æŒ‰æ€»ç­¹æ¬¾é‡‘é¢æ’åºçš„ä¼—ç­¹é¡¹ç›® TOP 30 æ¦œå•ï¼Œ"
                    "è¦†ç›– Kickstarter / Indiegogo / Makuake ä¸‰ä¸ªå¹³å°ï¼Œå¹¶ç»™å‡ºä¸“ä¸šè§£è¯»ã€‚"
                ),
            ),
            TaskShortcut(
                id="project_fast_speed_30d",
                title="ç­¹æ¬¾é€Ÿåº¦å† å†›",
                subtitle="æœ€å¿«ç­¹æ»¡çš„é¡¹ç›®æœ‰å“ªäº›",
                prompt_template=(
                    "è¯·æ‰¾å‡ºæœ€è¿‘30å¤©ç­¹æ¬¾é€Ÿåº¦æœ€å¿«çš„ä¸€æ‰¹ä¼—ç­¹é¡¹ç›®ï¼ˆä¾‹å¦‚å‰20åï¼‰ï¼Œ"
                    "åˆ†æå®ƒä»¬åœ¨å“ç±»ã€å›½å®¶ã€å®šä»·ã€å›æŠ¥è®¾è®¡ç­‰æ–¹é¢çš„å…±æ€§ï¼Œå¹¶ç»™å‡ºä½ çš„è§‚å¯Ÿç»“è®ºã€‚"
                ),
            ),
            TaskShortcut(
                id="project_deep_analysis",
                title="å•é¡¹ç›®æ·±åº¦åˆ†æ",
                subtitle="è¾“å…¥é¡¹ç›®åæˆ–é“¾æ¥",
                prompt_template=(
                    "è¯·å¯¹ä¸‹é¢è¿™ä¸ªä¼—ç­¹é¡¹ç›®åšä¸€æ¬¡æ·±åº¦åˆ†æï¼ŒåŒ…å«ï¼šé¡¹ç›®æ¦‚å†µã€å‘èµ·æ–¹èƒŒæ™¯ã€äº§å“äº®ç‚¹ã€"
                    "ç­¹æ¬¾è¡¨ç°ã€æ½œåœ¨é£é™©ã€å¸‚åœºå‰æ™¯ä»¥åŠç»™æ½œåœ¨æ”¯æŒè€…/ä»ä¸šè€…çš„å»ºè®®ã€‚\n\né¡¹ç›®åç§°æˆ–é“¾æ¥ï¼š"
                ),
            ),
        ],
    )

    _AGENTS[default_agent.key] = default_agent
    _AGENTS[brand_agent.key] = brand_agent
    _AGENTS[project_agent.key] = project_agent


def list_agents() -> List[AgentConfig]:
    """è¿”å›å…¨éƒ¨å·²æ³¨å†Œ Agentï¼ˆå½“å‰åªæœ‰é»˜è®¤ä¸€ä¸ªï¼‰"""
    if not _AGENTS:
        _init_builtin_agents()
    return list(_AGENTS.values())


def get_agent(key: str) -> Optional[AgentConfig]:
    """æŒ‰ key è·å– AgentConfig"""
    if not _AGENTS:
        _init_builtin_agents()
    return _AGENTS.get(key)


def get_default_agent() -> AgentConfig:
    """è·å–é»˜è®¤ Agent"""
    if not _AGENTS:
        _init_builtin_agents()
    return _AGENTS[_DEFAULT_KEY]
